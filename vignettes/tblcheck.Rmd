---
title: "tblcheck"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{tblcheck}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

[learnr]: https://rstudio.github.io/learnr/
[gradethis]: https://pkgs.rstudio.com/gradethis/articles/gradethis.html

```{css echo=FALSE}
.alert {
  padding: 0.5em 1em;
  margin: 1em 2em;
  border: 1px #eee solid;
  border-radius: 5px;
}
.alert.alert-success {
  background-color: #e4f2dc;
  border-color: #ddedcf;
}
.alert.alert-success,
.alert.alert-success code,
.alert.alert-success code a:not(.close):not(.btn) {
  color: #5c9653;
}
.alert.alert-danger {
  background-color: #f2e2e2;
  border-color: #eed9dc;
}
.alert.alert-danger,
.alert.alert-danger code,
.alert.alert-danger code a:not(.close):not(.btn) {
  color: #ad3532;
}
.alert code {
  background-color: #ffffff55;
}
```

```{r, include = FALSE}
library(dplyr)
library(gradethis)
library(knitr)
library(rlang)
library(tblcheck)
library(tibble)

opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

options(max.print = 20)

# Add hooks to turn a chunk into an unevaluated verbatim exercise chunk
# adapted from https://bookdown.org/yihui/rmarkdown-cookbook/show-header.html
knitr::knit_hooks$set(chunk_label = function(before, options) {
  # the original chunk might be indented
  indent <- options$indent %||% ""
  in_grade_this <- isTRUE(options$grade_this)
  is_exercise <- isTRUE(options$is_exercise)
  
  code <- 
    if (before) {
      c(
        sprintf(
          "```{r %s%s}",
          options$chunk_label,
          if (is_exercise) ", exercise=TRUE" else ""
        ),
        if (in_grade_this) "grade_this({"
      )
    } else {
      c(
        if (in_grade_this) "})",
        "```"
      )
    }
  
  paste0(indent, code, collapse = "\n")
})

knitr::opts_hooks$set(chunk_label = function(options) {
  options$eval <- FALSE
  options
})

og_source_hook <- knitr::knit_hooks$get("source")
knitr::knit_hooks$set(source = function(x, options) {
  if (!is.null(options$chunk_label)) {
    indent <- options$indent %||% ""
    in_grade_this <- isTRUE(options$grade_this)
    paste0(
      indent, 
      c("", paste0(if (in_grade_this) "  ", x), ""),
      collapse = "\n"
    )
  } else {
    og_source_hook(x, options)
  }
})

# approximate the appearance of a grade in a learnr tutorial
grade_html <- function(grade) {
  x <- paste0(
    '<div class="',
    if (!length(grade$correct)) {
      "alert" 
    } else if (isTRUE(grade$correct)) {
      "alert alert-success"
    } else {
      "alert alert-danger"
    },
    '">',
    grade$message,
    "</div>"
  )
  knitr::asis_output(x)
}

fake_grade_chunks <- function(
  user,
  solution = paste0(user, "-solution"),
  check = paste0(user, "-check"),
  setup = paste0(user, "-setup")
) {
  setup <- knitr::knit_code$get(setup)
  if (!is.null(setup)) {
    suppressMessages(eval(parse(text = setup), envir = .GlobalEnv))
  }
  
  force(solution)
  force(check)
  
  user <- paste0(
    ".result <- ", paste(knitr::knit_code$get(user), collapse = "")
  )
  solution <- paste0(
    ".solution <- ", paste(knitr::knit_code$get(solution), collapse = "")
  )
  check <- knitr::knit_code$get(check)
  
  env <- new.env()

  eval(parse(text = user), envir = env)
  print(env$.result)
  eval(parse(text = solution), envir = env)
  grade <- tryCatch(
    eval(parse(text = check), envir = env),
    gradethis_graded = identity
  )
  if (inherits(grade, "gradethis_graded")) return(grade_html(grade))
  if (!is.null(grade)) print(grade)
}
```

## Overview

tblcheck works with [gradethis] to help instructors compare students' exercise results with intended solutions in [learnr] tutorials.
If you are new to grading learnr tutorials, we recommend that you get comfortable with [gradethis] before incorporating tblcheck.

tblcheck provides two grading modalities. You can:

1. Compare student output to model solutions with the [`grade` function family](#grading-tables), or

1. Write custom grading logic with the [`check` function family](#custom-mistake-handling).

To use tblcheck in a learnr tutorial, load tblcheck after learnr and gradethis in the `setup` chunk of your tutorial:

````markdown
```{r setup}`r ''`
library(learnr)
library(gradethis)
library(tblcheck)
```
````

## Grading tables

`tbl_grade_table()` compares the result of the user's input to the result of the `-solution` chunk. It checks that the user's table

1. is the correct class
1. has the correct column names
1. has the correct number of rows and columns

and that each column of the user's table

4. is the correct class
5. contains the correct values

`tbl_grade_table()` includes options to disable any of these checks. If a check fails, the student will see a single message with the first detected problem, based on the order described above.

To use `tbl_grade_table()`, ensure you have a `-solution` chunk and add `tbl_grade_table()` to the grading code in you `-check` chunk, e.g.

````markdown
```{r example-check, chunk_label = "example-check", grade_this = TRUE}
pass_if_equal()
tbl_grade_table()
fail()
```
````

By default, `tblcheck` functions compare the `gradethis` objects `.result` and `.solution`, just like `gradethis::pass_if_equal()`.

### Example

In this exercise, a student is asked to create the following table:

```{r}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, FALSE),
  color = c("green", "red")
)
```

````markdown
```{r blank, chunk_label = "food", is_exercise = TRUE}
# student code will go here
```

```{r blank-solution, chunk_label = "food-solution"}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, FALSE),
  color = c("green", "red")
)
```

```{r blank-check, chunk_label = "food-check", grade_this = TRUE}
tbl_grade_table()
```
````

### Checking the correct answer

If the student gives the correct answer, `tbl_grade_table()` produces no output. This let's you hand off checking to other `gradethis` functions. Be sure to include a function like `pass()` or `pass_if_equal()` in your checking code to ensure students can get a passing grade!

````markdown
```{r exercise, chunk_label = "food", is_exercise = TRUE}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, FALSE),
  color = c("green", "red")
)
```

```{r exercise-solution, chunk_label = "food-solution"}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, FALSE),
  color = c("green", "red")
)
```

```{r exercise-check, chunk_label = "food-check", grade_this = TRUE}
tbl_grade_table()
```
````

```{r echo=FALSE}
fake_grade_chunks("exercise")
```

### Finding problems

If the user's submitted table differs from the correct table, `tbl_grade_table()` returns a failing grade and a message with an explanation for what went wrong. If there are multiple problems with a student's submission, `tbl_grade_table()` tries to give the most actionable item first.

#### Checking class

First, `tbl_grade_table()` ensures that the class of the student's submission matches the class of the expected solution.

````markdown
```{r exercise-2, chunk_label = "food", is_exercise = TRUE}
list(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, FALSE),
  color = c("green", "red")
)
```

```{r exercise-2-solution, chunk_label = "food-solution"}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, FALSE),
  color = c("green", "red")
)
```

```{r exercise-2-check, chunk_label = "food-check", grade_this = TRUE}
tbl_grade_table()
```
````

```{r echo=FALSE}
fake_grade_chunks("exercise-2")
```

#### Checking column names

Next, the code checks that the student used the correct column names, and hasn't missed any columns or included any unexpected columns.

````markdown
```{r exercise-3, chunk_label = "food", is_exercise = TRUE}
tibble(
  food = c("lettuce", "tomato"),
  fruit = c(TRUE, FALSE),
  color = c("green", "red")
)
```

```{r exercise-3-solution, chunk_label = "food-solution"}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, FALSE),
  color = c("green", "red")
)
```

```{r exercise-3-check, chunk_label = "food-check", grade_this = TRUE}
tbl_grade_table()
```
````

```{r echo=FALSE}
fake_grade_chunks("exercise-3")
```

#### Checking length

Next, `tbl_grade_table()` checks that the student has submitted the correct number of rows.

````markdown
```{r exercise-4, chunk_label = "food", is_exercise = TRUE}
tibble(
  food = "tomato",
  vegetable = FALSE,
  color = "red"
)
```

```{r exercise-4-solution, chunk_label = "food-solution"}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, FALSE),
  color = c("green", "red")
)
```

```{r exercise-4-check, chunk_label = "food-check", grade_this = TRUE}
tbl_grade_table()
```
````

```{r echo=FALSE}
fake_grade_chunks("exercise-4")
```

#### Checking column classes

Next, `tbl_grade_table()` checks that each individual column contains the correct type of data.

````markdown
```{r exercise-5, chunk_label = "food", is_exercise = TRUE}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(1, 0),
  color = c("green", "red")
)
```

```{r exercise-5-solution, chunk_label = "food-solution"}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, FALSE),
  color = c("green", "red")
)
```

```{r exercise-5-check, chunk_label = "food-check", grade_this = TRUE}
tbl_grade_table()
```
````

```{r echo=FALSE}
fake_grade_chunks("exercise-5")
```

#### Checking column values

Finally, `tbl_grade_table()` gives a hint as to what the values in each column should look like.

````markdown
```{r exercise-6, chunk_label = "food", is_exercise = TRUE}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, TRUE),
  color = c("green", "red")
)
```

```{r exercise-6-solution, chunk_label = "food-solution"}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, FALSE),
  color = c("green", "red")
)
```

```{r exercise-6-check, chunk_label = "food-check", grade_this = TRUE}
tbl_grade_table()
```
````

```{r echo=FALSE}
fake_grade_chunks("exercise-6")
```

## Grading vectors

For exercises that use vectors rather than tables, `vec_grade_vector()` allows you to apply the same tests that are normally applied to the columns of a table. It checks that the user's vector

1. is the correct class
1. is the correct length
1. has the correct factor levels (if the vector is a factor)
1. contains the correct values
1. has the correct names (if the vector has names)

`vec_grade_vector()` includes options to disable any of these checks. If a check fails, the student will see a single message with the first detected problem, based on the order described above.

To use `vec_grade_vector()`, ensure you have a `-solution` chunk and add `vec_grade_vector()` to the grading code in you `-check` chunk, e.g.

````markdown
```{r vector-example-check, chunk_label = "vector-check", grade_this = TRUE}
pass_if_equal()
vec_grade_vector()
fail()
```
````

By default, `tblcheck` functions compare the `gradethis` objects `.result` and `.solution`, just like `gradethis::pass_if_equal()`.

### Example

In this exercise, a student is asked to create the following vector:

```{r}
factor(c("lettuce", "tomato", "avocado"))
```

````markdown
```{r blank-vector, chunk_label = "food", is_exercise = TRUE}
# student code will go here
```

```{r blank-vector-solution, chunk_label = "food-solution"}
factor(c("lettuce", "tomato", "avocado"))
```

```{r blank-vector-check, chunk_label = "food-check", grade_this = TRUE}
vec_grade_vector()
```
````

### Checking the correct answer

If the student gives the correct answer, `vec_grade_vector()` produces no output. This let's you hand off checking to other `gradethis` functions. Be sure to include a function like `pass()` or `pass_if_equal()` in your checking code to ensure students can get a passing grade!

````markdown
```{r vector, chunk_label = "food", is_exercise = TRUE}
factor(c("lettuce", "tomato", "avocado"))
```

```{r vector-solution, chunk_label = "food-solution"}
factor(c("lettuce", "tomato", "avocado"))
```

```{r vector-check, chunk_label = "food-check", grade_this = TRUE}
vec_grade_vector()
```
````

```{r echo=FALSE}
fake_grade_chunks("vector")
```

### Finding problems

If the user's submitted vector differs from the correct vector, `vec_grade_vector()` returns a failing grade and a message with an explanation for what went wrong. If there are multiple problems with a student's submission, `vec_grade_vector()` tries to give the most actionable item first.

For example, if the student submits a vector of the wrong class, that will be the first message returned by `vec_grade_vector()`.

````markdown
```{r vector-2, chunk_label = "food", is_exercise = TRUE}
c("lettuce", "tomato", "avocado")
```

```{r vector-2-solution, chunk_label = "food-solution"}
factor(c("lettuce", "tomato", "avocado"))
```

```{r vector-2-check, chunk_label = "food-check", grade_this = TRUE}
vec_grade_vector()
```
````

```{r echo=FALSE}
fake_grade_chunks("vector-2")
```

## Other grading functions

`tbl_grade_table()` and `vec_grade_vector()` calls a number of grading functions internally. You can call these functions directly to perform more specific grading.

- `tbl_grade_column()` applies the tests in `vec_grade_vector()` to a single column of a table.
- `tbl_grade_class()` and `vec_grade_class()` grade the class of an object.
- `tbl_grade_dimensions()` and `vec_grade_dimensions()` grade the length and dimensions of an object.
- `tbl_grade_names()` and `vec_grade_names()` grade the names of an object.
- `tbl_grade_groups()` grades the groups of a table.
- `vec_grade_levels()` grades the levels of a factor.
- `vec_grade_values()` grades the values of a vector.

## Skipping tests

If there are some tests you would like to skip, `tbl_grade_table()` and `vec_grade_vector()` include a host of arguments that can be set to `FALSE`. For example:

````markdown
```{r numbers, chunk_label = "numbers", is_exercise = TRUE}
data.frame(numbers = 1:5) %>%
  mutate(even = numbers %% 2 == 0)
```

```{r numbers-solution, chunk_label = "numbers-solution"}
tibble(numbers = 1:5) %>%
  mutate(even = numbers %% 2 == 0)
```

```{r numbers-check, chunk_label = "numbers-check", grade_this = TRUE}
tbl_grade_table()
```
````

```{r echo=FALSE}
fake_grade_chunks("numbers")
```

When the user's result is a different class than the expected solution, `tbl_grade_table()` gives a failing grade. If you don't care about the class of the table, you can add `check_class = FALSE`.

````markdown
```{r numbers_2-check, chunk_label = "numbers-check", grade_this = TRUE}
tbl_grade_table(check_class = FALSE)
```
````

```{r echo=FALSE}
fake_grade_chunks("numbers", check = "numbers_2-check")
```

Since there are no other problems, we get no output.

Every test performed by `tbl_grade_table()` or `vec_grade_vector()` can be disabled with an argument.

## Custom mistake handling

Sometimes, we want to give special handling to a specific circumstance. For example, in this exercise, a student is instructed to use `grepl()` to find which storm names from `dplyr::storms` contain double letters.

````markdown
```{r storms-setup, chunk_label = "storms-setup"}
names <- unique(dplyr::storms$name)
```

```{r storms, chunk_label = "storms", is_exercise = TRUE}
grep("(.)\\1", names)
```

```{r storms-solution, chunk_label = "storms-solution"}
grepl("(.)\\1", names)
```

```{r storms-check, chunk_label = "storms-check", grade_this = TRUE}
vec_grade_vector()
```
````

```{r echo=FALSE}
fake_grade_chunks("storms")
```

In this exercise, the student accidentally used `grep()` instead of `grepl()`, If this is a mistake you expect a lot of students to make, you may want to give it special handling. All `grade` functions have a `check` equivalent, allowing you to add custom handling for any detected mistake.

For example, where `vec_grade_vector()` returns a _grade_, `vec_check_vector()` returns a _problem_ that you can inspect in your grading code.

````markdown
```{r storms-2-check, chunk_label = "storms-check", grade_this = TRUE}
vec_check_vector()
```
````

```{r echo=FALSE}
fake_grade_chunks("storms", check = "storms-2-check")
```

You can use `if` statements to give specific feedback based on the nature of the `problem` object using the standard `gradethis` functions. For problems not handled by your custom grading code, you can pass the problem to `tbl_grade()` to create a grade from the problem using the default feedback provided by tblchecks' `grade` functions.

````markdown
```{r storms-3-check, chunk_label = "storms-check", grade_this = TRUE}
problem <- vec_check_vector()

if (problem$type == "class" && problem$actual == "integer") {
  fail("Did you use `grep()` instead of `grepl()`?")
} else {
  tbl_grade(problem)
}
```
````

```{r echo=FALSE}
fake_grade_chunks("storms", check = "storms-3-check")
```

**Tip**: You can also use `if` statements to ignore differences that you don't care about in your grading code.

Applying the same code to a different mistake, we retain the normal `vec_grade_vector()` functionality, like in this example where the student uses the wrong regex pattern:

````markdown
```{r storms-4, chunk_label = "storms", is_exercise = TRUE}
grepl("..", names)
```

```{r storms-4-solution, chunk_label = "storms-solution"}
grepl("(.)\\1", names)
```

```{r storms-4-check, chunk_label = "storms-check", grade_this = TRUE}
vec_grade_vector()
```
````

```{r echo=FALSE}
fake_grade_chunks("storms-4")
```
