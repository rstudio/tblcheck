---
title: "tblcheck"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{tblcheck}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

[learnr]: https://rstudio.github.io/learnr/
[gradethis-get-started]: https://pkgs.rstudio.com/gradethis/articles/gradethis.html
[gradethis]: https://pkgs.rstudio.com/gradethis/

```{css echo=FALSE}
.alert {
  padding: 0.5em 1em;
  margin: 1em 2em;
  border: 1px #eee solid;
  border-radius: 5px;
}
.alert.alert-success {
  background-color: #e4f2dc;
  border-color: #ddedcf;
}
.alert.alert-success,
.alert.alert-success code,
.alert.alert-success code a:not(.close):not(.btn) {
  color: #5c9653;
}
.alert.alert-danger {
  background-color: #f2e2e2;
  border-color: #eed9dc;
}
.alert.alert-danger,
.alert.alert-danger code,
.alert.alert-danger code a:not(.close):not(.btn) {
  color: #ad3532;
}
.alert code {
  background-color: #ffffff55;
}

.callout {
  padding: 1.5rem 1.5rem 1.5rem 80px;
  margin: 1em 0;
  background-size: 40px;
  background-repeat: no-repeat;
  background-position: 20px 1.5em;
  min-height: 80px;
  position: relative;
  border: 2px solid;
}

.callout::before {
  content: "!";
  display: flex;
  position: absolute;
  top: 0;
  left: 0;
  background-repeat: no-repeat;
  background-size: contain;
  width: 40px;
  height: 40px;
  transform: translate(20px, 20px) scale(1);
  transition: transform 0.15s linear, background-color 0.2s linear;
  font-weight: bold;
  font-size: 2em;
  background-color: #486181;
  color: white;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.callout:first-child {
  margin-top: 0;
}

.callout p:last-child {
  margin-bottom: 0;
}

.callout {
  border-color: #b5c1d2;
}

.callout p, .callout ol, .callout ul {
  color: #486181;
}

.callout h3, .callout h4 {
  color: #294263;
}

.callout p code, .callout ol code, .callout ul code, .callout h3 code, .callout h4 code {
  background-color: #e9f2fd;
  color: #294263;
}

.callout blockquote {
  border-color: #b5c1d1;
}
```

```{r, include = FALSE}
library(dplyr)
library(gradethis)
gradethis_setup(fail.hint = FALSE, fail.encourage = FALSE)
library(knitr)
library(rlang)
library(tblcheck)
library(tibble)

opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

set.seed(424341)
options(max.print = 20, width = 70)

# Add hooks to turn a chunk into an unevaluated verbatim exercise chunk
# adapted from https://bookdown.org/yihui/rmarkdown-cookbook/show-header.html
knitr::knit_hooks$set(chunk_label = function(before, options) {
  # the original chunk might be indented
  indent <- options$indent %||% ""
  in_grade_this <- isTRUE(options$grade_this)
  is_exercise <- isTRUE(options$is_exercise)
  
  code <- 
    if (before) {
      c(
        sprintf(
          "```{r %s%s}",
          options$chunk_label,
          if (is_exercise) ", exercise=TRUE" else ""
        ),
        if (in_grade_this) "grade_this({"
      )
    } else {
      c(
        if (in_grade_this) "})",
        if (!nzchar(trimws(paste(options$code, collapse = "\n")))) "\n",
        "```"
      )
    }
  
  paste0(indent, code, collapse = "\n")
})

knitr::opts_hooks$set(chunk_label = function(options) {
  options$eval <- FALSE
  options
})

og_source_hook <- knitr::knit_hooks$get("source")
knitr::knit_hooks$set(source = function(x, options) {
  if (!is.null(options$chunk_label)) {
    indent <- options$indent %||% ""
    in_grade_this <- isTRUE(options$grade_this)
    paste0(
      indent, 
      c("", paste0(if (in_grade_this) "  ", x), ""),
      collapse = "\n"
    )
  } else {
    og_source_hook(x, options)
  }
})

# approximate the appearance of a grade in a learnr tutorial
grade_html <- function(grade) {
  x <- paste0(
    '<div class="',
    if (!length(grade$correct)) {
      "alert" 
    } else if (isTRUE(grade$correct)) {
      "alert alert-success"
    } else {
      "alert alert-danger"
    },
    '">',
    grade$message,
    "</div>"
  )
  knitr::asis_output(x)
}

fake_grade_chunks <- function(
  user,
  solution = paste0(user, "-solution"),
  check = paste0(user, "-check"),
  setup = paste0(user, "-setup")
) {
  setup <- knitr::knit_code$get(setup)
  
  force(solution)
  force(check)
  
  user <- knitr::knit_code$get(user)
  solution <- knitr::knit_code$get(solution)
  check <- knitr::knit_code$get(check)
  
  env <- new.env()

  if (!is.null(setup)) {
    suppressMessages(eval(parse(text = setup), envir = env))
  }
  assign(".result", eval(parse(text = user), envir = env), envir = env)
  assign(".solution", eval(parse(text = solution), envir = env), envir = env)
  assign(".user_code", user, envir = env)
  assign(".solution_code", solution, envir = env)
  grade <- tryCatch(
    eval(parse(text = check), envir = env),
    gradethis_graded = identity
  )
  if (inherits(grade, "gradethis_graded")) return(grade_html(grade))
  if (!is.null(grade)) print(grade)
}
```

## Overview

tblcheck works with [gradethis] to help instructors compare students' exercise results with intended solutions in [learnr] tutorials.
If you are new to grading learnr tutorials, we recommend that you [get comfortable with gradethis][gradethis-get-started] before incorporating tblcheck into your tutorials.

tblcheck provides two grading modalities. You can:

1. Compare student output to model solutions with the [`grade` function family](#grading-tables), or

1. Write custom grading logic with the [`check` function family](#custom-mistake-handling).

To use tblcheck in a learnr tutorial, load tblcheck after learnr and gradethis in the `setup` chunk of your tutorial:

````markdown
```{r setup}`r ''`
library(learnr)
library(gradethis)
library(tblcheck)
```
````

## Grading tables

### Automated table checking

`tbl_grade_table()` compares the result of the user's input to the result of the `-solution` chunk, automatically returning targeted feedback to the user if any problems are discovered.

`tbl_grade_table()` checks that the user's table

1. is the correct class,
1. has the correct column names,
1. has the correct number of rows and columns,
1. and that each column of the user's table
    1. is the correct class and
    1. contains the correct values.

If any of these checks detect a problem in the submitted code, the student will see a single message with the first detected issue, based on the order described above.

### Usage

To use `tbl_grade_table()`, ensure you have a `-solution` chunk and add `tbl_grade_table()` to the grading code in your `-check` chunk, e.g.

````markdown
```{r example-check, chunk_label = "example-check", grade_this = TRUE}
pass_if_equal()
tbl_grade_table()
fail()
```
````

By default, `tblcheck` functions compare the `gradethis` objects `.result` and `.solution`, just like `gradethis::pass_if_equal()` and `gradethis::fail_if_equal()`.

::: callout
Be sure to include a function like `pass()` or `pass_if_equal()` in your checking code to ensure students can get a passing grade!

`tbl_grade_table()` only returns feedback to the student if it discovers a problem; if the student gives the correct answer, it produces no output.
This lets you quickly check for simple problems, following up with more detailed checking with other `gradethis` functions.
:::

### Finding problems

If the user's submitted table differs from the correct table, `tbl_grade_table()` returns a failing grade and a message with an explanation for what went wrong. 
If there are multiple problems with a student's submission, `tbl_grade_table()` tries to give the most actionable item first.

We'll demonstrate how this works for a simple exercise that asks students to create the following table using `tibble()`.

```{r example-table-prompt, echo=FALSE}
solution_table <- tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, FALSE),
  color = c("green", "red")
)
knitr::kable(solution_table)
```

In the R Markdown source of the learnr tutorial, we use an exercise chunk labelled `food`, with a `food-solution` chunk with the expected solution and a `food-check` chunk with the exercise checking code using [gradethis] and tblcheck.

````markdown
```{r ex-food, chunk_label = "food", is_exercise = TRUE}

```

```{r ex-food-solution, chunk_label = "food-solution"}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, FALSE),
  color = c("green", "red")
)
```

```{r ex-food-check, chunk_label = "food-check", grade_this = TRUE}
pass_if_equal()
tbl_grade_table()
fail()
```
````

We'll use this example throughout the sections that follow to demonstrate how tblcheck will respond to various types of errors that students may make.
Keep in mind this is a contrived example designed for this vignette.
In real-world usage, students are likely to only encounter one or two of the problems `tbl_grade_table()` is designed to find.

#### Checking class

First, `tbl_grade_table()` ensures that the class of the student's submission matches the class of the expected solution.
Here, the student attempts to store the data in the table as a list rather than by using `tibble()`.

```{r exercise-2}
list(
  food = "lettuce",
  fruit = "TRUE",
  color = "green"
)
```

```{r echo=FALSE}
fake_grade_chunks("exercise-2", solution = "ex-food-solution", check = "ex-food-check")
```

Based on this advice, the student revises their solution to use `tibble()` instead of `list()`.

#### Checking column names

Next, the code checks that the student used the correct column names, and they haven't missed any columns or included any unexpected columns.
Here, `tbl_grade_table()` notices that the student has an unexpected column named `fruit`.

```{r exercise-3}
tibble(
  food = "lettuce",
  fruit = "TRUE",
  color = "green"
)
```

```{r echo=FALSE}
fake_grade_chunks("exercise-3", solution = "ex-food-solution", check = "ex-food-check")
```

Based on this advice, the student revises their solution to name the second column `vegetable` instead of `fruit`.

#### Checking length

Next, `tbl_grade_table()` checks that the student has submitted the correct number of rows, and in this case notices that the student has only included one row.

```{r exercise-4}
tibble(
  food = "lettuce",
  vegetable = "TRUE",
  color = "green"
)
```

```{r echo=FALSE}
fake_grade_chunks("exercise-4", solution = "ex-food-solution", check = "ex-food-check")
```

Based on this advice, the student realizes they've only entered the first row of the table.
They go back to the example table and add the second row to their submission.

#### Checking column classes

Next, `tbl_grade_table()` checks that each individual column contains the correct type of data.
Here, the student has stored the values of the `vegetable` column as a string, but we were expecting them to be logical values.

```{r exercise-5}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c("TRUE", "TRUE"),
  color = c("green", "red")
)
```

```{r echo=FALSE}
fake_grade_chunks("exercise-5", solution = "ex-food-solution", check = "ex-food-check")
```

Based on this advice, the student removes the `"` around the values in the `vegetable` column to use R's logical `TRUE`.

#### Checking column values

Finally, `tbl_grade_table()` gives a hint as to what the values in each column should look like.
Here, the student made a mistake during their transcription of the `vegetable` column.

```{r exercise-6}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, TRUE),
  color = c("green", "red")
)
```

```{r echo=FALSE}
fake_grade_chunks("exercise-6", solution = "ex-food-solution", check = "ex-food-check")
```

Based on this advice, the student revises their submission, changing the second value of the `vegetable` column from `TRUE` to `FALSE`.


```{r exercise-7}
tibble(
  food = c("lettuce", "tomato"),
  vegetable = c(TRUE, FALSE),
  color = c("green", "red")
)
```

```{r echo=FALSE}
fake_grade_chunks("exercise-7", solution = "ex-food-solution", check = "ex-food-check")
```


## Grading vectors

### Automated vector checking

Many of the table-grading tests that apply to the _columns_ of tables can also be applied to vectors — after all, data frame columns in R are _vectors_.

When your exercise uses vectors rather than tables, `vec_grade_vector()` allows you to apply the same tests that are normally applied to the columns of a table to a vector.
It checks that the user's vector

1. is the correct class
1. is the correct length
1. has the correct factor levels (if the vector is a factor)
1. contains the correct values
1. has the correct names (if the vector has names)

Like `tbl_grade_table()`, if a problem is detected by any of these checks, the student will see a single message with the first detected problem, based on the order described above.

### Usage

To use `vec_grade_vector()`, ensure you have a `-solution` chunk and add `vec_grade_vector()` to the grading code in your `-check` chunk, e.g.

````markdown
```{r vector-example-check, chunk_label = "vector-check", grade_this = TRUE}
pass_if_equal()
vec_grade_vector()
fail()
```
````

Just like `tbl_grade_table()` and other tblcheck functions, `vec_grade_vector()` automatically compares the user's `.result` to the `.solution` when used in `gradethis::grade_this()`.
Note that `vec_grade_vector()` only returns feedback when a problem is detected, so be sure to include `gradethis::pass()` or `gradethis::pass_if_equal()` to ensure that students can get a passing grade.

### Finding problems

If the user's submitted vector differs from the correct vector, `vec_grade_vector()` returns a failing grade and a message with an explanation for what went wrong. If there are multiple problems with a student's submission, `vec_grade_vector()` tries to give the most actionable item first.

Suppose an exercise asks a student to create a factor of the sandwich toppings — _lettuce_, _tomato_, _avocado_.

```{r}
factor(c("lettuce", "tomato", "avocado"))
```

In the R Markdown source of the learnr tutorial, we use an exercise chunk labelled `toppings`, with a `toppings-solution` chunk with the expected solution and a `toppings-check` chunk with the exercise checking code using [gradethis] and tblcheck.

````markdown
```{r ex-vector, chunk_label = "toppings", is_exercise = TRUE}

```

```{r ex-vector-solution, chunk_label = "toppings-solution"}
factor(c("lettuce", "tomato", "avocado"))
```

```{r ex-vector-check, chunk_label = "toppings-check", grade_this = TRUE}
pass_if_equal()
vec_grade_vector()
fail()
```
````

For example, if the student submits a vector of the wrong class, that will be the first message returned by `vec_grade_vector()`.

```{r vector-1}
c("lettuce", "tomato", "avocado")
```

```{r echo=FALSE}
fake_grade_chunks("vector-1", "ex-vector-solution", "ex-vector-check")
```

If the student submits a factor with the wrong factor levels, `vec_grade_vector()` will warn the student about their mistake.

```{r vector-2}
factor(c("lettuce", "tomato", "avocado"), c("lettuce", "tomato", "avocado"))
```

```{r echo=FALSE}
fake_grade_chunks("vector-2", "ex-vector-solution", "ex-vector-check")
```

### Finding problems

If the user's submitted vector differs from the correct vector, `vec_grade_vector()` returns a failing grade and a message with an explanation for what went wrong. If there are multiple problems with a student's submission, `vec_grade_vector()` tries to give the most actionable item first.

For example, if the student submits a vector of the wrong class, that will be the first message returned by `vec_grade_vector()`.

````markdown
```{r vector-2, chunk_label = "food", is_exercise = TRUE}
c("lettuce", "tomato", "avocado")
```

```{r vector-2-solution, chunk_label = "food-solution"}
factor(c("lettuce", "tomato", "avocado"))
```

```{r vector-2-check, chunk_label = "food-check", grade_this = TRUE}
vec_grade_vector()
```
````

```{r echo=FALSE}
fake_grade_chunks("vector-2")
```

## Choosing checked properties

### Skipping tests

If there are some tests you would like to skip, `tbl_grade_table()` and `vec_grade_vector()` include a host of arguments that can be set to `FALSE`.

In this example, the student will receive a failing grade because they have created a `data.frame` when the exercise expects a `tibble`.

````markdown
```{r numbers, chunk_label = "numbers", is_exercise = TRUE}
data.frame(numbers = 1:5) %>%
  mutate(even = numbers %% 2 == 0)
```

```{r numbers-solution, chunk_label = "numbers-solution"}
tibble(numbers = 1:5) %>%
  mutate(even = numbers %% 2 == 0)
```

```{r numbers-check, chunk_label = "numbers-check", grade_this = TRUE}
tbl_grade_table()
```
````

```{r echo=FALSE}
fake_grade_chunks("numbers")
```

If you don't care about the class of the table, you can add `check_class = FALSE` to `tbl_grade_table()`. This will skip checking the table's class, but still run all other tests.

````markdown
```{r numbers-2, chunk_label = "numbers", is_exercise = TRUE}
data.frame(numbers = 1:5) %>%
  mutate(even = numbers %% 2 == 0)
```

```{r numbers-2-solution, chunk_label = "numbers-solution"}
tibble(numbers = 1:5) %>%
  mutate(even = numbers %% 2 == 0)
```

```{r numbers-2-check, chunk_label = "numbers-check", grade_this = TRUE}
tbl_grade_table(check_class = FALSE)
```
````

```{r echo=FALSE}
fake_grade_chunks("numbers-2")
```

Since the only problem with the student's submission was the class of the table, this new check code gives no output.

Every test performed by `tbl_grade_table()` or `vec_grade_vector()` can be disabled with an argument.

### Other grading functions

`tbl_grade_table()` and `vec_grade_vector()` calls a number of grading functions internally. You can call these functions directly to perform more specific grading.

- `tbl_grade_column()` applies the tests in `vec_grade_vector()` to a single column of a table.
- `tbl_grade_class()` and `vec_grade_class()` grade the class of an object.
- `tbl_grade_dimensions()` and `vec_grade_dimensions()` grade the length and dimensions of an object.
- `tbl_grade_names()` and `vec_grade_names()` grade the names of an object.
- `tbl_grade_groups()` grades the groups of a table.
- `vec_grade_levels()` grades the levels of a factor.
- `vec_grade_values()` grades the values of a vector.

## Custom mistake handling

Sometimes, we want to give special handling to a specific circumstance. For example, in this exercise, a student is instructed to use `grepl()` to find which storm names from `dplyr::storms` contain double letters.

````markdown
```{r storms-setup, chunk_label = "storms-setup"}
names <- unique(dplyr::storms$name)
```

```{r storms, chunk_label = "storms", is_exercise = TRUE}
grep("(.)\\1", names)
```

```{r storms-solution, chunk_label = "storms-solution"}
grepl("(.)\\1", names)
```

```{r storms-check, chunk_label = "storms-check", grade_this = TRUE}
vec_grade_vector()
```
````

```{r echo=FALSE}
fake_grade_chunks("storms")
```

In this exercise, the student accidentally used `grep()` instead of `grepl()`, If this is a mistake you expect a lot of students to make, you may want to give it special handling. All `grade` functions have a `check` equivalent, allowing you to add custom handling for any detected mistake.

For example, where `vec_grade_vector()` returns a _grade_, `vec_check_vector()` returns a _problem_ that you can inspect in your grading code.

````markdown
```{r storms-2-check, chunk_label = "storms-check", grade_this = TRUE}
vec_check_vector()
```
````

```{r echo=FALSE}
fake_grade_chunks("storms", check = "storms-2-check")
```

You can use `if` statements to give specific feedback based on the nature of the `problem` object using the standard `gradethis` functions. For problems not handled by your custom grading code, you can pass the problem to `tbl_grade()` to create a grade from the problem using the default feedback provided by tblchecks' `grade` functions. (If there are no problems, `tbl_grade(problem)` wont return anything.)

````markdown
```{r storms-3-check, chunk_label = "storms-check", grade_this = TRUE}
problem <- vec_check_vector()

if (problem$type == "class" && problem$actual == "integer") {
  fail("Did you use `grep()` instead of `grepl()`?")
}

tbl_grade(problem)
```
````

```{r echo=FALSE}
fake_grade_chunks("storms", check = "storms-3-check")
```

**Tip**: You can also use `if` statements to ignore differences that you don't care about in your grading code.

Applying the same code to a different mistake, we retain the normal `vec_grade_vector()` functionality, like in this example where the student uses the wrong regex pattern:

````markdown
```{r storms-4, chunk_label = "storms", is_exercise = TRUE}
grepl("..", names)
```

```{r storms-4-solution, chunk_label = "storms-solution"}
grepl("(.)\\1", names)
```

```{r storms-4-check, chunk_label = "storms-check", grade_this = TRUE}
problem <- vec_check_vector()

if (problem$type == "class" && problem$actual == "integer") {
  fail("Did you use `grep()` instead of `grepl()`?")
}

tbl_grade(problem)
```
````

```{r echo=FALSE}
fake_grade_chunks("storms-4")
```
