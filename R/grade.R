#' Apply automatic grading to a problem object
#'
#' @param problem A problem generated by a `tbl_check_*()` function.
#' @inheritParams tbl_check_table
#' @param ... Additional arguments passed to [gradethis::fail()].
#'
#' @return A [gradethis::fail()] message or `NULL` invisibly.
#' @export
#' 
#' @examples
#' .result <- 1:10
#' .solution <- letters[1:10]
#' problem <- tbl_check_vector()
#' tbl_grade(problem)
tbl_grade <- function(problem, max_diffs = 3, ...) {
  UseMethod("tbl_grade")
}

#' @rdname tbl_grade
#' @export
tbl_grade.default <- function(problem, max_diffs = 3, ...) {
  invisible()
}

#' @rdname tbl_grade
#' @export
tbl_grade.list <- function(problem, max_diffs = 3, ...) {
  problem <- as_problem(problem)
  tbl_grade(problem, max_diffs = max_diffs, ...)
}

#' @rdname tbl_grade
#' @export
tbl_grade.tblcheck_problem <- function(problem, max_diffs = 3, ...) {
  if (is.null(problem) || isFALSE(problem$message)) {
    return(invisible())
  }
  
  assert_internally({
    checkmate::assert_class(problem, "tblcheck_problem")
    checkmate::assert_number(max_diffs, lower = 1)
  })
  
  return_fail(
    tbl_message(problem, max_diffs = max_diffs),
    problem = problem,
    ...
  )
}

tbl_message <- function(problem, ...) {
  UseMethod("tbl_message")
}

tbl_message.default <- function(problem, ...) {
  invisible()
}

tbl_message.tblcheck_problem <- function(problem, ...) {
  type_msg <- if (!is.null(problem$type)) {
    problem_type <- problem$type
    "Your code resulted in a {problem_type} problem. "
  } else {
    ""
  }
  
  exp_msg <- if (!is.null(problem$expected)) {
    expected <- paste(md_code(problem$expected), collapse = ", ")
    "I was expecting a value of {expected}. "
  } else {
    ""
  }
  
  obj_msg <- if (!is.null(problem$actual)) {
    actual <- paste(md_code(problem$actual), collapse = ", ")
    "Your result gave a value of {actual}. "
  } else {
    ""
  }
  
  glue::glue(type_msg, exp_msg, obj_msg)
}

isFALSE <- function(x) {
  is.logical(x) && length(x) == 1L && !is.na(x) && !x
}
